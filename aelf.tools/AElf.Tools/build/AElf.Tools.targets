<?xml version="1.0"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <PropertyGroup>
        <_Tools_MsBuildAssembly Condition=" '$(_Tools_MsBuildAssembly)' == '' and '$(MSBuildRuntimeType)' == 'Core'  ">..\lib\netstandard1.3\AElf.Tools.dll</_Tools_MsBuildAssembly>
        <_Tools_MsBuildAssembly Condition=" '$(_Tools_MsBuildAssembly)' == '' and '$(MSBuildRuntimeType)' != 'Core'  ">..\lib\net46\AElf.Tools.dll</_Tools_MsBuildAssembly>
        <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
        <ObjPath>$(ProjectDir)obj/$(Configuration)/$(TargetFramework)/</ObjPath>
    </PropertyGroup>

    <Target Name="CleanObjBeforeBuild" BeforeTargets="CodeCompile;Restore">
        <RemoveDir Directories="$(ObjPath)Protobuf" />
    </Target>
    
    <!-- Name of this file must match package ID. -->
    <!-- Packages will be split later. -->
    <Import Project="_contract/_Contract.Tools.targets"/>
    <Import Project="_protobuf/Google.Protobuf.Tools.targets"/>
    <Import Project="_patch/Patch.Tools.targets"/>

    <UsingTask AssemblyFile="$(_Tools_MsBuildAssembly)" TaskName="AElf.Tools.ResolveProtoPath" />
    <Target Name="ProtoRecoginziton" BeforeTargets="BeforeBuild">
        <ItemGroup>
            <ProtoAllRef Include="@(PackageReference)" Condition=" '%(PackageReference.Identity)' == 'AElf.ACS1' OR '%(PackageReference.Identity)' == 'AElf.ACS2' " />
        </ItemGroup>
        
        <ResolveProtoPath
                Condition=" '@(ProtoAllRef)' != '' "
                ProtoAllRef="@(ProtoAllRef)"
                ReferencePath="@(ReferencePath)"
                NugetRoot="$(NuGetPackageRoot)">
            <Output TaskParameter="TargetBaseProto" ItemName="_TargetBaseProtos"/>
            <Output TaskParameter="TargetBasePath" ItemName="_TargetBasePaths"/>
            <Output TaskParameter="TargetRefProto" ItemName="_TargetRefProtos"/>
            <Output TaskParameter="TargetRefPath" ItemName="_TargetRefPaths"/>
        </ResolveProtoPath>
        
        <ItemGroup>
            <Protobuf Include="@(_TargetBaseProtos)" Condition=" @(_TargetBaseProtos) != ''">    
                <ContractOutputOptions>nocontract</ContractOutputOptions>
                <OutputDir>$(ObjPath)Protobuf/base</OutputDir>
            </Protobuf>
            <Protobuf Include="@(_TargetRefProtos)" Condition=" @(_TargetRefProtos) != ''">
                <ContractOutputOptions>reference</ContractOutputOptions>
                <Access>Internal</Access>
                <OutputDir>$(ObjPath)Protobuf/reference</OutputDir>
            </Protobuf>
            
            <Protobuf Include="Protobuf/base/*.proto">
                <ContractOutputOptions>nocontract</ContractOutputOptions>
            </Protobuf>
            <Protobuf Include="Protobuf/contract/*.proto" />
            <Protobuf Include="Protobuf/message/*.proto">
                <ContractOutputOptions>nocontract</ContractOutputOptions>
            </Protobuf>
            <Protobuf Include="Protobuf/reference/*.proto">
                <ContractOutputOptions>reference</ContractOutputOptions>
                <Access>Internal</Access>
            </Protobuf>
            <Protobuf Include="Protobuf/stub/*.proto">
                <ContractOutputOptions>stub</ContractOutputOptions>
                <Access>Internal</Access>
            </Protobuf>
        </ItemGroup>
    </Target>
    
</Project>
